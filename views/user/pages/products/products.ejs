<div class="container mx-auto mt-8 flex gap-6">
    <!-- Filters Sidebar -->
    <aside class="w-1/4 p-5 border-r bg-gray-50 rounded-md">
        <h3 class="text-lg font-semibold mb-4">Filters</h3>

        <form action="/products" method="GET">
            <a href="/products?category=all" class="border block text-center cursor-pointer px-4 py-2 rounded w-full mb-5 hover:bg-gray-200 transition">
                RESET
            </a>

            <!-- Category Filter -->
            <h4 class="font-medium mb-3 text-gray-700">CATEGORY</h4>
            <div class="space-y-3" 
                x-data="{ 
                    categories: JSON.parse('<%= JSON.stringify(categories) %>'),
                    selectedCategory: null,
                    init() {
                        const params = new URLSearchParams(window.location.search);
                        const category = params.get('category');
                        if (category) {
                            this.selectedCategory = category;
                        }
                    }
                }">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="category" value="all" x-model="selectedCategory">
                    <span class="text-gray-600">All</span>
                </label>
                <template x-for="category in categories" :key="category._id">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="category" :value="category._id" x-model="selectedCategory">
                        <span x-text="category.name" class="text-gray-600"></span>
                    </label>
                </template>
            </div>
            <button type="submit" class="mt-5 bg-blue-500 text-white py-2 px-4 rounded-md w-full">
                Apply Filter
            </button>
        </form>
    </aside>

    <!-- Product Grid & Sorting -->
    <div class="w-3/4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-semibold">Our Products</h2>

            <!-- Sorting Dropdown -->
            <form action="/products" method="GET" class="flex gap-3">
                <input type="hidden" name="category" value="<%= category || 'all' %>">
                <select name="sort" class="border px-3 py-2 rounded-md">
                    <option value="">Sort By</option>
                    <option value="priceLow" <%= sort === 'priceLow' ? 'selected' : '' %>>Price: Low to High</option>
                    <option value="priceHigh" <%= sort === 'priceHigh' ? 'selected' : '' %>>Price: High to Low</option>
                    <option value="nameAsc" <%= sort === 'nameAsc' ? 'selected' : '' %>>Name: A to Z</option>
                    <option value="nameDesc" <%= sort === 'nameDesc' ? 'selected' : '' %>>Name: Z to A</option>
                    <option value="discountHigh" <%= sort === 'discountHigh' ? 'selected' : '' %>>Highest Discount</option>
                </select>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">
                    Sort
                </button>
            </form>
        </div>

        <!-- Search Bar -->

        <form id="productSearch" class="max-w-md mb-8">
                <label for="default-search" class="mb-2 text-sm font-medium text-gray-900 sr-only">Search</label>
                <div class="relative">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                        <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
                        </svg>
                    </div>
                    <input
                    type="search"
                    id="default-search"
                    value="<%= search || '' %>"
                    class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Search products..."
                    />
                    <button
                    type="button"
                    id="clear-search"
                    class="absolute end-12 bottom-2.5 text-gray-500 hover:text-gray-700 "
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <button type="submit" class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2">
                        Search
                    </button>
                </div>
            </form>

        <!-- Loading and Error States -->
        <div id="loading" class="text-center py-4 hidden">
            Loading products...
        </div>
        <div id="error" class="text-center py-4 text-red-500 hidden"></div>
        <div id="no-results" class="text-center py-4 text-gray-500 hidden">
            No products found.
        </div>

        <!-- Product Grid -->
        <div
          id="product-grid"
          x-data="{ wishlistIds: JSON.parse('<%= JSON.stringify(wishlistIds) %>') }"
          class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
        >
            <% products.forEach((product) => { %>
                <a
                  href="/products/<%= product._id %>"
                  class="block bg-white relative p-5 rounded-xl shadow-md hover:shadow-lg transition"
                >
                    <img
                      src="<%= product.images.cardImage.path %>"
                      alt="<%= product.productName %>"
                      class="w-full h-64 object-cover rounded-lg"
                    />
                    <button class="wishlist-btn">
                        <div
                          :class="{'text-red-500': wishlistIds.includes('<%= product._id.toString() %>')}"
                          class="absolute top-8 right-8"
                        >
                            <svg width="33" height="20" viewBox="0 0 33 30" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path
                                  data-product-id="<%= product._id %>"
                                  d="M3.73799 16.5186L15.8114 27.9829C16.1374 28.2924 16.3004 28.4472 16.5 28.4472C16.6996 28.4472 16.8626 28.2924 17.1886 27.9829L29.262 16.5186C32.5238 13.4213 32.9209 8.36131 30.1821 4.7932L29.6132 4.05203C26.3131 -0.247499 19.6328 0.468379 17.3187 5.36956C16.9921 6.06127 16.0079 6.06127 15.6813 5.36956C13.3672 0.468379 6.68694 -0.247495 3.38678 4.05203L2.81788 4.7932C0.0791311 8.36131 0.476197 13.4213 3.73799 16.5186Z"
                                  stroke="currentColor"
                                  stroke-width="2"
                                />
                            </svg>
                        </div>
                    </button>
                    <%- include("../../partials/molecules/cardTextBlock.ejs", { product }) %>
                </a>
            <% }) %>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center mt-8">
            <% if (currentPage > 1) { %>
                <a
                  href="/products?page=<%= currentPage - 1 %>&category=<%= category || '' %>&sort=<%= sort || '' %>&search=<%= search || '' %>"
                  class="bg-blue-500 text-white px-4 py-2 mx-2 rounded-md"
                >Previous</a>
            <% } %>
            <span class="px-4 py-2 border rounded-md bg-gray-100">
                Page <%= currentPage %> of <%= totalPages %>
            </span>
            <% if (currentPage < totalPages) { %>
                <a
                  href="/products?page=<%= currentPage + 1 %>&category=<%= category || '' %>&sort=<%= sort || '' %>&search=<%= search || '' %>"
                  class="bg-blue-500 text-white px-4 py-2 mx-2 rounded-md"
                >Next</a>
            <% } %>
        </div>
    </div>
</div>

<script type="module" src="/javascript/ajax/pages/userProduct.js"></script>